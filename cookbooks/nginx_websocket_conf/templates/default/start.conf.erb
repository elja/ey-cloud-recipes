server {  
  listen 80;
  server_name beta.construcs.com;
  rewrite ^ https://beta.construcs.com$request_uri? permanent;						    
}

server {
  listen 80;
  server_name construcs.com;
  rewrite ^ http://www.construcs.com$request_uri? permanent;
}

server {
  listen 443;
  
  server_name beta.construcs.com;
  
  client_max_body_size 100M;
  
  root /data/Construcs/current/public;
  
  access_log /var/log/engineyard/nginx/Construcs.access.log main;
  error_log /var/log/engineyard/nginx/Construcs.error.log notice;
  
  location ~ ^/(images|assets|javascripts|stylesheets)/ {
    expires 10y;
    try_files  $uri $uri/index.html /last_assets/$uri /last_assets/$uri.html @app_ConstrucsSSL;
  }

  error_page 404 /404.html;
  error_page 500 502 504 /500.html;
  error_page 503 @503;
  
  recursive_error_pages on;
  
  location @503 {
    error_page 405 = /system/maintenance.html;
    if (-f $request_filename) {
      break;
    }
    rewrite ^(.*)$ /system/maintenance.html break;
  }

  location ~ ^/juggernaut.* {
    rewrite ^/juggernaut/(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:7002; 
  }

  location ~ ^/socket.io.* {
      proxy_pass http://127.0.0.1:7002;
  }

  ssl on;
  ssl_certificate /etc/nginx/ssl/Construcs.crt;
  ssl_certificate_key /etc/nginx/ssl/Construcs.key;
  ssl_prefer_server_ciphers on;
  ssl_protocols  SSLv3 TLSv1;
  ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!AESGCM;

  location @app_ConstrucsSSL {
    passenger_enabled on;
    passenger_set_cgi_param HTTP_X_FORWARDED_FOR   $proxy_add_x_forwarded_for;
    passenger_set_cgi_param HTTP_X_REAL_IP         $remote_addr;
    passenger_set_cgi_param HTTP_HOST              $http_host;
    passenger_set_cgi_param HTTP_X_FORWARDED_PROTO $scheme;
    passenger_set_cgi_param HTTP_X_REQUEST_START   't=$start_time';
    passenger_set_cgi_param HTTP_X_QUEUE_START     't=$start_time';   
    
    rack_env staging;
   
    passenger_min_instances 2;
  }
  
  location / {
    if (-f $document_root/system/maintenance.html) { return 503; }
      try_files  $uri $uri/index.html $uri.html @app_ConstrucsSSL;
  }
  
}

server {
  listen 80;

  server_name www.construcs.com;
  access_log /var/log/engineyard/nginx/Construcs.access.log main;
  error_log /var/log/engineyard/nginx/Construcs.error.log notice;

  client_max_body_size 100M;
  root /data/ConstrucsMarketing/public;
  location ~ ^/(images|assets|javascripts|stylesheets)/ {
     expires 10y;
     try_files  $uri $uri/index.html /last_assets/$uri /last_assets/$uri.html @app_ConstrucsMarketing;
  }
  
  error_page 404 /404.html;
  error_page 500 502 504 /500.html;
  error_page 503 @503;

  recursive_error_pages on;
  
  location @503 {
      error_page 405 = /system/maintenance.html;
      if (-f $request_filename) {
        break;
      }
      rewrite ^(.*)$ /system/maintenance.html break;
  }

  location ~ ^/juggernaut.* {
    rewrite ^/juggernaut/(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:7002;
  }

  location ~ ^/socket.io.* {
    proxy_pass http://127.0.0.1:7002;
  }


  location @app_ConstrucsMarketing {
      passenger_enabled on;
      passenger_set_cgi_param HTTP_X_FORWARDED_FOR   $proxy_add_x_forwarded_for;
      passenger_set_cgi_param HTTP_X_REAL_IP         $remote_addr;
      passenger_set_cgi_param HTTP_HOST              $http_host;
      passenger_set_cgi_param HTTP_X_FORWARDED_PROTO $scheme;
      passenger_set_cgi_param HTTP_X_REQUEST_START   't=$start_time';
      passenger_set_cgi_param HTTP_X_QUEUE_START     't=$start_time';

      rack_env staging;
      
      passenger_min_instances 1;
   }

   location / {
       if (-f $document_root/system/maintenance.html) { return 503; }
       try_files  $uri $uri/index.html $uri.html @app_ConstrucsMarketing;
   }
}

